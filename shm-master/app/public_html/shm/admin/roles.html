<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Назначение ролей</title>
<style>
body { font-family: sans-serif; background: #f8f8f8; }
table { border-collapse: collapse; width: 100%; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #eee; }
select, button { padding: 4px 8px; }
.status { font-size: 14px; margin: 10px 0; }
tr.error { background: #ffe0e0; }
tr.success { background: #e0ffe0; }
</style>
</head>
<body>
<h2>Пользователи и роли</h2>
<div class="status" id="status"></div>
<table id="users">
<thead><tr><th>ID</th><th>Логин</th><th>Роль</th><th>Назначить роль</th></tr></thead>
<tbody></tbody>
</table>
<script>
const session_id = localStorage.getItem('session_id');
const csrf_token = localStorage.getItem('csrf_token');
let roles = [];

function setStatus(msg, type) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = type === 'error' ? '#b00' : (type === 'success' ? '#080' : '#222');
}

function fetchRoles() {
  return fetch('/shm/object.cgi?object=User&method=get_roles&session_id=' + session_id)
    .then(r => r.json()).then(data => { roles = data.map(r => r.role); });
}

function fetchUsers() {
  return fetch('/shm/object.cgi?object=User&session_id=' + session_id)
    .then(r => r.json()).then(data => data.data || []);
}

function setRole(user_id, role) {
  const tr = document.querySelector(`tr[data-user='${user_id}']`);
  const btn = tr ? tr.querySelector('button') : null;
  setStatus('Назначение роли...', '');
  if (btn) btn.disabled = true;
  tr.classList.remove('error','success');
  fetch('/shm/object.cgi?object=User&method=set_role', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id, csrf_token, user_id, role })
  })
    .then(r => r.json())
    .then(resp => {
      if (resp.error) {
        setStatus('Ошибка: ' + resp.error, 'error');
        tr.classList.add('error');
      } else {
        setStatus('Роль успешно назначена', 'success');
        tr.classList.add('success');
        setTimeout(()=>location.reload(), 1000);
      }
    })
    .catch(e => { setStatus('Ошибка сети', 'error'); if (tr) tr.classList.add('error'); })
    .finally(() => { if (btn) btn.disabled = false; });
}

function render(users) {
  const tbody = document.querySelector('#users tbody');
  tbody.innerHTML = '';
  const myRole = localStorage.getItem('my_role');
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-user', u.user_id);
    tr.innerHTML = `<td>${u.user_id}</td><td>${u.login}</td><td>${u.role||''}</td>`;
    if (myRole === 'admin' || myRole === 'manager') {
      tr.innerHTML += `<td><select>${roles.map(r=>`<option${u.role===r?' selected':''}>${r}</option>`)}</select> <button>Назначить</button></td>`;
      tr.querySelector('button').onclick = () => setRole(u.user_id, tr.querySelector('select').value);
    } else {
      tr.innerHTML += '<td>-</td>';
    }
    tbody.appendChild(tr);
  });
}

fetchRoles().then(() => fetchUsers()).then(users => {
  fetch('/shm/object.cgi?object=User&session_id=' + session_id)
    .then(r => r.json()).then(data => {
      const me = data.data.find(u => u.user_id == localStorage.getItem('my_user_id'));
      localStorage.setItem('my_role', me ? me.role : '');
      render(users);
    });
});
</script>
</body>
</html>